{% extends "base.html" %}
{% block title %}Editar Defecto{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="fw-bold mb-4">Editar Defecto</h2>

  {% set user_roles = session.get('roles', []) %}
  {% set user_id = session.get('user_id') %}

  {% if 'admin' in user_roles or defect.assigned_to_id == user_id %}
  <form method="POST">
    <div class="mb-3">
      <label class="form-label">Título</label>
      <input type="text" name="titulo" value="{{ defect.titulo }}" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Descripción</label>
      <textarea name="descripcion" class="form-control" rows="4">{{ defect.descripcion }}</textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Estado</label>
      <select name="estado" class="form-select">
        {% for estado in ['Abierto', 'En progreso', 'Cerrado'] %}
        <option value="{{ estado }}" {% if defect.estado == estado %}selected{% endif %}>{{ estado }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Prioridad</label>
      <select name="prioridad" class="form-select">
        {% for p in ['Baja', 'Media', 'Alta'] %}
        <option value="{{ p }}" {% if defect.prioridad == p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Asignar a</label>
      <select name="assigned_to" class="form-select">
        <option value="">-- Sin asignar --</option>
        {% for usuario in usuarios %}
        <option value="{{ usuario.id }}" {% if defect.assigned_to_id == usuario.id %}selected{% endif %}>
          {{ usuario.username }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Sólo permitir cambiar 'verificado' si no tiene test_case ni result asociados -->
    {% if not defect.test_case_id and not defect.result_id %}
    <div class="mb-3 form-check">
        <input class="form-check-input" type="checkbox" id="verificado" name="verificado" value="1"
            {% if defect.verificado %}checked{% endif %}>
        <label class="form-check-label" for="verificado">Verificado (marcar si el defecto está resuelto y comprobado)</label>
    </div>
    {% endif %}


    <button type="submit" class="btn btn-primary">Guardar cambios</button>
    <a href="{{ url_for('defects_bp.index') }}" class="btn btn-secondary">Volver</a>
  </form>

  <form method="POST" action="{{ url_for('defects_bp.delete', id=defect.id) }}" class="mt-3">
    <button type="submit" class="btn btn-danger">Eliminar</button>
  </form>

  {% else %}
  <div class="alert alert-warning">
    No tienes permisos para editar este defecto.
  </div>
  {% endif %}
</div>
{% endblock %}
