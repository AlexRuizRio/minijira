{% extends "base.html" %}
{% block title %}{{ cycle.nombre }} - Detalle{% endblock %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">{{ cycle.nombre }}</h2>
    <a href="{{ url_for('test_bp.edit_cycle', id=cycle.id) }}" class="btn btn-outline-primary">Editar ciclo</a>
  </div>

  <p><strong>Estado:</strong> {{ cycle.estado.value | capitalize }}</p>
  <p><strong>Descripción:</strong> {{ cycle.descripcion or "Sin descripción" }}</p>

  <hr>

  <h4 class="mt-4">TestCases en este ciclo</h4>

  {% if cycle.testcases %}
  <table class="table table-hover align-middle mt-3">
    <thead class="table-light">
      <tr>
        <th>Test Case</th>
        <th>Tipo</th>
        <th>Prioridad</th>
        <th>Estado</th>
        <th>Resultado</th>
        <th>Fecha Ejecución</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>

      {% for case in cycle.testcases %}

        {# Buscar resultado del test case en ESTE ciclo #}
        {% set result = last_results.get(case.id) %}

      <tr>

        <!-- Nombre y descripción -->
        <td>
          <a href="{{ url_for('test_bp.show', id=case.id) }}" class="fw-bold">
            {{ case.nombre }}
          </a>
          <br>
          <small class="text-muted">
            {{ (case.descripcion or '')[:80] }}{% if case.descripcion and case.descripcion|length > 80 %}...{% endif %}
          </small>
        </td>

        <td>{{ case.tipo.value | capitalize if case.tipo else "—" }}</td>
        <td>{{ case.prioridad.value | capitalize if case.prioridad else "—" }}</td>
        <td>{{ case.estado.value | replace('_',' ') | capitalize if case.estado else "—" }}</td>

        <!-- Resultado -->
        <td>
            {% if result %}

              {% set color = {
                'pasado': 'bg-success',
                'fallido': 'bg-danger',
                'bloqueado': 'bg-warning',
                'en_progreso': 'bg-secondary'
              }[result.estado_prueba.value] %}

              <a href="{{ url_for('results.edit', id=result.id) }}"
                class="badge {{ color }} text-decoration-none">
                {{ result.estado_prueba.value | replace('_',' ') | capitalize }}
              </a>

            {% else %}
              <span class="text-muted">Sin ejecutar</span>
            {% endif %}
        </td>

        <!-- Fecha -->
        <td>
          {% if result %}
            {{ result.fecha_created.strftime('%d/%m/%Y %H:%M') }}
          {% else %}
            —
          {% endif %}
        </td>

        <!-- Acciones -->
        <td>
          <form action="{{ url_for('test_bp.remove_testcase_from_cycle', id=cycle.id, testcase_id=case.id) }}"
                method="POST" class="d-inline">
            <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
          </form>
        </td>

      </tr>
      {% endfor %}

    </tbody>
  </table>

  {% else %}
    <div class="alert alert-info mt-3">Aún no hay TestCases asignados a este ciclo.</div>
  {% endif %}

  <hr>

  <h5 class="mt-4">Agregar TestCase existente</h5>
  <form method="POST" action="{{ url_for('test_bp.add_testcase_to_cycle', id=cycle.id) }}" class="d-flex gap-2 mt-2">
    <select name="testcase_id" class="form-select" required>
      <option value="">Selecciona un TestCase...</option>
      {% for case in all_cases %}
      <option value="{{ case.id }}">{{ case.nombre }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-success">Agregar</button>
  </form>

  <hr>

  <div class="mt-4">
    <a href="{{ url_for('test_bp.index') }}" class="btn btn-secondary">Volver al listado</a>
  </div>

</div>
{% endblock %}
